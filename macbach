-- Auto Farm Level Blox Fruits - by M·∫°c B√°ch
-- Bay ƒë·∫øn qu√°i, ƒë·ª©ng tr√™n ƒë·∫ßu, t·ª± ƒë·ªông t√¨m qu√°i m·ªõi khi qu√°i ch·∫øt

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- D·ªÆ LI·ªÜU C√ÅC ƒê·∫¢O THEO LEVEL (Blox Fruits)
local IslandsData = {
    -- Starter Sea
    ["Starter Island"] = {
        level = 1,
        position = Vector3.new(100, 100, 100),
        npcs = {"Bandit", "Monkey"}
    },
    ["Jungle"] = {
        level = 10,
        position = Vector3.new(500, 100, 500),
        npcs = {"Gorilla", "Pirate"}
    },
    ["Pirate Village"] = {
        level = 20,
        position = Vector3.new(800, 100, 800),
        npcs = {"Pirate", "Brute"}
    },
    ["Desert"] = {
        level = 30,
        position = Vector3.new(1200, 100, 1200),
        npcs = {"Desert Bandit", "Desert Officer"}
    },
    ["Frozen Village"] = {
        level = 40,
        position = Vector3.new(1500, 100, 1500),
        npcs = {"Snow Bandit", "Snowman"}
    },
    ["Marine Fortress"] = {
        level = 50,
        position = Vector3.new(1800, 100, 1800),
        npcs = {"Marine", "Marine Captain"}
    }
}

-- C·∫§U H√åNH AUTO FARM
local AutoFarm = {
    Enabled = false,
    CurrentIsland = nil,
    FlyHeight = 15, -- ƒê·ªô cao bay tr√™n ƒë·∫ßu qu√°i
    TeleportSpeed = 100, -- T·ªëc ƒë·ªô teleport
    CheckRange = 500, -- Ph·∫°m vi ki·ªÉm tra qu√°i
    SafeDistance = 10, -- Kho·∫£ng c√°ch an to√†n
    TargetPriority = "Closest", -- ∆Øu ti√™n m·ª•c ti√™u
    Blacklist = {"Boss", "Dough King", "Raid Boss"},
    Whitelist = {}, -- Danh s√°ch qu√°i ∆∞u ti√™n farm
    ShowDebugInfo = true,
    AutoAcceptQuest = true, -- T·ª± ƒë·ªông nh·∫≠n nhi·ªám v·ª•
    QuestNPCs = {"Quest Giver", "Marine Captain", "Bandit Leader"}
}

-- BI·∫æN L∆ØU TR·ªÆ
local target = nil
local isFlying = false
local isAtIsland = false
local farmConnection = nil
local flyConnection = nil
local questAccepted = false
local stats = {
    TotalMobs = 0,
    CurrentIsland = nil,
    StartTime = os.time()
}

-- KI·ªÇM TRA LEVEL C·ª¶A NG∆Ø·ªúI CH∆†I
function getPlayerLevel()
    local data = player:FindFirstChild("Data")
    if data then
        local level = data:FindFirstChild("Level")
        if level then
            return level.Value
        end
    end
    return 1 -- M·∫∑c ƒë·ªãnh level 1 n·∫øu kh√¥ng t√¨m th·∫•y
end

-- X√ÅC ƒê·ªäNH ƒê·∫¢O PH√ô H·ª¢P V·ªöI LEVEL
function getSuitableIsland()
    local playerLevel = getPlayerLevel()
    local suitableIsland = nil
    local highestLevel = 0
    
    for islandName, islandData in pairs(IslandsData) do
        if playerLevel >= islandData.level and islandData.level > highestLevel then
            highestLevel = islandData.level
            suitableIsland = islandName
        end
    end
    
    return suitableIsland
end

-- L·∫§Y T·ªåA ƒê·ªò C·ª¶A ƒê·∫¢O
function getIslandPosition(islandName)
    if IslandsData[islandName] then
        return IslandsData[islandName].position
    end
    return Vector3.new(0, 100, 0) -- V·ªã tr√≠ m·∫∑c ƒë·ªãnh
end

-- T√åM T·∫§T C·∫¢ NPC TRONG B√ÅN K√çNH
function getAllNPCsInRange()
    local npcs = {}
    
    -- Ki·ªÉm tra trong c√°c folder NPC
    for _, folderName in pairs({"NPCs", "Enemies", "Characters"}) do
        local folder = Workspace:FindFirstChild(folderName)
        if folder then
            for _, npc in pairs(folder:GetChildren()) do
                if npc:IsA("Model") and npc:FindFirstChild("Humanoid") and npc:FindFirstChild("HumanoidRootPart") then
                    if npc.Humanoid.Health > 0 then
                        -- Ki·ªÉm tra blacklist
                        local isBlacklisted = false
                        for _, black in pairs(AutoFarm.Blacklist) do
                            if string.find(npc.Name:lower(), black:lower()) then
                                isBlacklisted = true
                                break
                            end
                        end
                        
                        if not isBlacklisted then
                            -- Ki·ªÉm tra kho·∫£ng c√°ch
                            local distance = (humanoidRootPart.Position - npc.HumanoidRootPart.Position).Magnitude
                            if distance <= AutoFarm.CheckRange then
                                table.insert(npcs, {
                                    model = npc,
                                    position = npc.HumanoidRootPart.Position,
                                    distance = distance,
                                    health = npc.Humanoid.Health,
                                    maxHealth = npc.Humanoid.MaxHealth
                                })
                            end
                        end
                    end
                end
            end
        end
    end
    
    return npcs
end

-- T√åM NPC T·ªêT NH·∫§T ƒê·ªÇ FARM
function findBestTarget()
    local npcs = getAllNPCsInRange()
    if #npcs == 0 then return nil end
    
    local bestTarget = nil
    local bestScore = -math.huge
    
    for _, npcData in pairs(npcs) do
        local score = 0
        
        if AutoFarm.TargetPriority == "Closest" then
            score = AutoFarm.CheckRange - npcData.distance
        elseif AutoFarm.TargetPriority == "LowestHP" then
            score = 1000 - npcData.health
        elseif AutoFarm.TargetPriority == "HighestXP" then
            -- NPC c√≥ level cao h∆°n cho nhi·ªÅu XP
            score = npcData.maxHealth * 10
        end
        
        -- ∆Øu ti√™n whitelist
        for _, white in pairs(AutoFarm.Whitelist) do
            if string.find(npcData.model.Name:lower(), white:lower()) then
                score = score + 5000
                break
            end
        end
        
        if score > bestScore then
            bestScore = score
            bestTarget = npcData.model
        end
    end
    
    return bestTarget
end

-- TELEPORT ƒê·∫æN V·ªä TR√ç
function teleportTo(position, heightOffset)
    local targetPosition = position + Vector3.new(0, heightOffset or AutoFarm.FlyHeight, 0)
    
    -- T·∫Øt tr·ªçng l·ª±c v√† di chuy·ªÉn
    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    humanoidRootPart.CFrame = CFrame.new(targetPosition)
    
    return true
end

-- BAY ƒê·∫æN QU√ÅI V√Ä ƒê·ª®NG TR√äN ƒê·∫¶U
function flyToTarget(npc)
    if not npc or not npc:FindFirstChild("HumanoidRootPart") then return false end
    
    print("[M·∫†C B√ÅCH] ƒêang bay ƒë·∫øn: " .. npc.Name)
    
    -- L·∫•y v·ªã tr√≠ ch√≠nh x√°c c·ªßa qu√°i
    local targetPosition = npc.HumanoidRootPart.Position
    
    -- Teleport ƒë·∫øn v·ªã tr√≠ tr√™n ƒë·∫ßu qu√°i
    teleportTo(targetPosition, AutoFarm.FlyHeight)
    
    -- Gi·ªØ v·ªã tr√≠ tr√™n ƒë·∫ßu qu√°i
    if flyConnection then
        flyConnection:Disconnect()
    end
    
    flyConnection = RunService.Heartbeat:Connect(function()
        if npc and npc:FindFirstChild("HumanoidRootPart") and npc.Humanoid.Health > 0 then
            local newPosition = npc.HumanoidRootPart.Position + Vector3.new(0, AutoFarm.FlyHeight, 0)
            humanoidRootPart.CFrame = CFrame.new(newPosition)
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
        else
            -- Qu√°i ƒë√£ ch·∫øt, ng·ª´ng bay
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            target = nil
        end
    end)
    
    isFlying = true
    target = npc
    return true
end

-- T·ª∞ ƒê·ªòNG NH·∫¨N NHI·ªÜM V·ª§
function autoAcceptQuest()
    if not AutoFarm.AutoAcceptQuest then return end
    
    -- T√¨m NPC nhi·ªám v·ª•
    for _, npcName in pairs(AutoFarm.QuestNPCs) do
        for _, obj in pairs(Workspace:GetChildren()) do
            if obj:IsA("Model") and string.find(obj.Name:lower(), npcName:lower()) then
                local distance = (humanoidRootPart.Position - obj.PrimaryPart.Position).Magnitude
                if distance <= 50 then
                    -- T·ª± ƒë·ªông click ƒë·ªÉ nh·∫≠n nhi·ªám v·ª•
                    local clickDetector = obj:FindFirstChildOfClass("ClickDetector")
                    if clickDetector then
                        fireclickdetector(clickDetector)
                        print("[M·∫†C B√ÅCH] ƒê√£ nh·∫≠n nhi·ªám v·ª• t·ª´: " .. obj.Name)
                        questAccepted = true
                        return true
                    end
                end
            end
        end
    end
    
    return false
end

-- ƒê·∫æN ƒê·∫¢O PH√ô H·ª¢P
function goToSuitableIsland()
    local islandName = getSuitableIsland()
    if not islandName then
        print("[M·∫†C B√ÅCH] Kh√¥ng t√¨m th·∫•y ƒë·∫£o ph√π h·ª£p!")
        return false
    end
    
    local islandPosition = getIslandPosition(islandName)
    AutoFarm.CurrentIsland = islandName
    stats.CurrentIsland = islandName
    
    print("[M·∫†C B√ÅCH] ƒêang ƒë·∫øn ƒë·∫£o: " .. islandName .. " (Level y√™u c·∫ßu: " .. IslandsData[islandName].level .. ")")
    
    -- Teleport ƒë·∫øn ƒë·∫£o
    teleportTo(islandPosition, 100)
    
    -- Nh·∫≠n nhi·ªám v·ª• n·∫øu c√≥
    task.wait(2)
    autoAcceptQuest()
    
    isAtIsland = true
    return true
end

-- V√íNG L·∫∂P FARM CH√çNH
function mainFarmLoop()
    if not AutoFarm.Enabled or humanoid.Health <= 0 then return end
    
    -- KI·ªÇM TRA ƒê·∫æN ƒê·∫¢O CH∆ØA
    if not isAtIsland then
        goToSuitableIsland()
        return
    end
    
    -- T√åM V√Ä BAY ƒê·∫æN QU√ÅI
    if not target then
        target = findBestTarget()
        
        if target then
            flyToTarget(target)
            stats.TotalMobs = stats.TotalMobs + 1
        else
            -- KH√îNG C√ì QU√ÅI, DI CHUY·ªÇN T√åM KI·∫æM
            local randomPos = humanoidRootPart.Position + Vector3.new(
                math.random(-100, 100),
                AutoFarm.FlyHeight,
                math.random(-100, 100)
            )
            teleportTo(randomPos)
        end
    else
        -- KI·ªÇM TRA QU√ÅI C√íN S·ªêNG KH√îNG
        if not target:FindFirstChild("Humanoid") or target.Humanoid.Health <= 0 then
            print("[M·∫†C B√ÅCH] Qu√°i ƒë√£ ch·∫øt, t√¨m qu√°i m·ªõi...")
            target = nil
            
            -- D·ª´ng bay
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
        else
            -- ƒêANG ƒê·ª®NG TR√äN ƒê·∫¶U QU√ÅI, KH√îNG L√ÄM G√å C·∫¢
            -- (Ch·ªù qu√°i b·ªã ti√™u di·ªát b·ªüi ng∆∞·ªùi kh√°c ho·∫∑c script kh√°c)
        end
    end
end

-- T·∫†O GUI ƒêI·ªÄU KHI·ªÇN
function createControlGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "MacBachLevelFarm"
    ScreenGui.Parent = player:WaitForChild("PlayerGui")
    
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 350, 0, 250)
    MainFrame.Position = UDim2.new(0, 20, 0, 20)
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    MainFrame.BackgroundTransparency = 0.05
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui
    
    -- HEADER
    local Header = Instance.new("Frame")
    Header.Size = UDim2.new(1, 0, 0, 40)
    Header.BackgroundColor3 = Color3.fromRGB(30, 30, 50)
    Header.Parent = MainFrame
    
    local Title = Instance.new("TextLabel")
    Title.Text = "üöÄ AUTO FARM LEVEL BLOX FRUITS"
    Title.Size = UDim2.new(1, 0, 1, 0)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.fromRGB(255, 100, 100)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    Title.Parent = Header
    
    local SubTitle = Instance.new("TextLabel")
    SubTitle.Text = "by M·∫°c B√°ch - Bay ƒë·∫øn qu√°i & ƒë·ª©ng tr√™n ƒë·∫ßu"
    SubTitle.Size = UDim2.new(1, 0, 0, 20)
    SubTitle.Position = UDim2.new(0, 0, 1, -20)
    SubTitle.BackgroundTransparency = 1
    SubTitle.TextColor3 = Color3.fromRGB(100, 200, 255)
    SubTitle.Font = Enum.Font.Gotham
    SubTitle.TextSize = 12
    SubTitle.Parent = Header
    
    -- CONTROL PANEL
    local ControlPanel = Instance.new("Frame")
    ControlPanel.Size = UDim2.new(1, -20, 0, 120)
    ControlPanel.Position = UDim2.new(0, 10, 0, 50)
    ControlPanel.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    ControlPanel.BorderSizePixel = 0
    ControlPanel.Parent = MainFrame
    
    local StartBtn = Instance.new("TextButton")
    StartBtn.Name = "StartBtn"
    StartBtn.Text = "‚ñ∂ B·∫ÆT ƒê·∫¶U FARM LEVEL"
    StartBtn.Size = UDim2.new(0.9, 0, 0, 45)
    StartBtn.Position = UDim2.new(0.05, 0, 0.1, 0)
    StartBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
    StartBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    StartBtn.Font = Enum.Font.GothamBold
    StartBtn.TextSize = 16
    StartBtn.Parent = ControlPanel
    
    local StopBtn = Instance.new("TextButton")
    StopBtn.Name = "StopBtn"
    StopBtn.Text = "‚è∏ D·ª™NG FARM"
    StopBtn.Size = UDim2.new(0.9, 0, 0, 45)
    StopBtn.Position = UDim2.new(0.05, 0, 0.6, 0)
    StopBtn.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
    StopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    StopBtn.Font = Enum.Font.Gotham
    StopBtn.TextSize = 14
    StopBtn.Visible = false
    StopBtn.Parent = ControlPanel
    
    -- INFO PANEL
    local InfoPanel = Instance.new("Frame")
    InfoPanel.Size = UDim2.new(1, -20, 0, 60)
    InfoPanel.Position = UDim2.new(0, 10, 0, 180)
    InfoPanel.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    InfoPanel.BorderSizePixel = 0
    InfoPanel.Parent = MainFrame
    
    local LevelLabel = Instance.new("TextLabel")
    LevelLabel.Name = "LevelLabel"
    LevelLabel.Text = "Level: ƒêang t·∫£i..."
    LevelLabel.Size = UDim2.new(1, -20, 0, 25)
    LevelLabel.Position = UDim2.new(0, 10, 0, 5)
    LevelLabel.BackgroundTransparency = 1
    LevelLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    LevelLabel.Font = Enum.Font.Gotham
    LevelLabel.TextSize = 14
    LevelLabel.TextXAlignment = Enum.TextXAlignment.Left
    LevelLabel.Parent = InfoPanel
    
    local IslandLabel = Instance.new("TextLabel")
    IslandLabel.Name = "IslandLabel"
    IslandLabel.Text = "ƒê·∫£o: Ch∆∞a ch·ªçn"
    IslandLabel.Size = UDim2.new(1, -20, 0, 25)
    IslandLabel.Position = UDim2.new(0, 10, 0, 30)
    IslandLabel.BackgroundTransparency = 1
    IslandLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    IslandLabel.Font = Enum.Font.Gotham
    IslandLabel.TextSize = 14
    IslandLabel.TextXAlignment = Enum.TextXAlignment.Left
    IslandLabel.Parent = InfoPanel
    
    -- S·ª∞ KI·ªÜN BUTTONS
    StartBtn.MouseButton1Click:Connect(function()
        AutoFarm.Enabled = true
        StartBtn.Visible = false
        StopBtn.Visible = true
        print("[M·∫†C B√ÅCH] ƒê√£ b·∫≠t Auto Farm Level!")
    end)
    
    StopBtn.MouseButton1Click:Connect(function()
        AutoFarm.Enabled = false
        StartBtn.Visible = true
        StopBtn.Visible = false
        
        -- D·ª´ng bay
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        
        print("[M·∫†C B√ÅCH] ƒê√£ d·ª´ng Auto Farm Level")
    end)
    
    -- C·∫¨P NH·∫¨T TH√îNG TIN
    spawn(function()
        while ScreenGui.Parent do
            task.wait(1)
            
            -- C·∫¨P NH·∫¨T LEVEL
            local playerLevel = getPlayerLevel()
            LevelLabel.Text = "Level: " .. playerLevel
            
            -- C·∫¨P NH·∫¨T ƒê·∫¢O
            if AutoFarm.CurrentIsland then
                IslandLabel.Text = "ƒê·∫£o: " .. AutoFarm.CurrentIsland
            end
            
            -- C·∫¨P NH·∫¨T M·ª§C TI√äU
            if target and AutoFarm.ShowDebugInfo then
                local distance = (humanoidRootPart.Position - target.HumanoidRootPart.Position).Magnitude
                print(string.format("[DEBUG] Target: %s | Distance: %.1f | HP: %d/%d", 
                    target.Name, distance, target.Humanoid.Health, target.Humanoid.MaxHealth))
            end
        end
    end)
    
    return ScreenGui
end

-- B·∫¨T/T·∫ÆT AUTO FARM
function toggleAutoFarm(state)
    AutoFarm.Enabled = state
    
    if state then
        print("üöÄ AUTO FARM LEVEL BLOX FRUITS - by M·∫°c B√°ch")
        print("üìä Level hi·ªán t·∫°i: " .. getPlayerLevel())
        print("üéØ T√≠nh nƒÉng: Bay ƒë·∫øn qu√°i & ƒë·ª©ng tr√™n ƒë·∫ßu")
        print("‚ö° Kh√¥ng t·ª± ƒë·ªông ƒë√°nh - Ch·ªâ h·ªó tr·ª£ positioning")
        
        if farmConnection then
            farmConnection:Disconnect()
        end
        
        farmConnection = RunService.Heartbeat:Connect(function()
            mainFarmLoop()
        end)
    else
        if farmConnection then
            farmConnection:Disconnect()
            farmConnection = nil
        end
        
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        
        print("‚è∏ ƒê√£ t·∫Øt Auto Farm Level")
    end
end

-- KH·ªûI T·∫†O
function initialize()
    print("üéÆ Auto Farm Level Blox Fruits")
    print("üë§ Creator: M·∫°c B√°ch")
    print("üåü Ch·ªâ bay ƒë·∫øn qu√°i & ƒë·ª©ng tr√™n ƒë·∫ßu")
    
    -- T·∫°o GUI
    createControlGUI()
    
    -- Ki·ªÉm tra level ban ƒë·∫ßu
    local initialLevel = getPlayerLevel()
    print("üìà Level hi·ªán t·∫°i c·ªßa b·∫°n: " .. initialLevel)
    
    -- X·ª≠ l√Ω khi ch·∫øt
    humanoid.Died:Connect(function()
        toggleAutoFarm(false)
        print("[H·ªÜ TH·ªêNG] Nh√¢n v·∫≠t ƒë√£ ch·∫øt, t·∫°m d·ª´ng Auto Farm")
    end)
    
    -- H·ªìi sinh
    player.CharacterAdded:Connect(function(newChar)
        character = newChar
        humanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
        humanoid = newChar:WaitForChild("Humanoid")
        
        if AutoFarm.Enabled then
            task.wait(3)
            toggleAutoFarm(true)
        end
    end)
    
    -- H∆∞·ªõng d·∫´n
    task.wait(2)
    print("\n=== H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG ===")
    print("1. Nh·∫•n 'B·∫ÆT ƒê·∫¶U FARM LEVEL' ƒë·ªÉ b·∫≠t")
    print("2. Script s·∫Ω t·ª± ƒë·ªông:")
    print("   - Ki·ªÉm tra level c·ªßa b·∫°n")
    print("   - Ch·ªçn ƒë·∫£o ph√π h·ª£p")
    print("   - Teleport ƒë·∫øn ƒë·∫£o")
    print("   - T·ª± ƒë·ªông nh·∫≠n nhi·ªám v·ª• (n·∫øu c√≥)")
    print("   - Bay ƒë·∫øn qu√°i v√† ƒë·ª©ng tr√™n ƒë·∫ßu")
    print("   - Khi qu√°i ch·∫øt, t·ª± ƒë·ªông t√¨m qu√°i m·ªõi")
    print("3. B·∫°n c·∫ßn c√≥ script ƒë√°nh t·ª± ƒë·ªông ri√™ng")
    print("4. K√©o th·∫£ GUI ƒë·ªÉ di chuy·ªÉn")
end

-- CH·∫†Y KH·ªûI T·∫†O
initialize()
