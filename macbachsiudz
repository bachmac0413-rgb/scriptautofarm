-- Script Auto Farm Qu√©t Qu√°i 5000 Studs - by M·∫°c B√°ch
-- T·ª± ƒë·ªông qu√©t qu√°i, bay ƒë·∫øn t·ª´ng con v√† ƒë√°nh ch·∫øt
-- T·ªëc ƒë·ªô bay 250, xuy√™n t∆∞·ªùng (NoClip), Gom 4 qu√°i

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- ==================== C·∫§U H√åNH ====================
local Config = {
    -- Auto Farm
    Enabled = false,
    ScanRange = 5000, -- Ph·∫°m vi qu√©t qu√°i
    AttackRange = 50, -- Kho·∫£ng c√°ch t·∫•n c√¥ng
    MaxTargets = 50, -- S·ªë l∆∞·ª£ng m·ª•c ti√™u t·ªëi ƒëa
    WaitAfterKill = 1, -- Ch·ªù sau khi gi·∫øt qu√°i
    
    -- Bay
    FlyHeight = 30, -- ƒê·ªô cao bay tr√™n ƒë·∫ßu qu√°i
    FlySpeed = 250, -- T·ªëc ƒë·ªô bay 250 (t·ªëi ƒëa)
    CurrentSpeed = 250, -- T·ªëc ƒë·ªô hi·ªán t·∫°i (m·∫∑c ƒë·ªãnh 250)
    UseFly = true,
    
    -- Xuy√™n t∆∞·ªùng
    NoClip = true, -- B·∫≠t xuy√™n t∆∞·ªùng m·∫∑c ƒë·ªãnh
    AntiStuck = true, -- Ch·ªëng k·∫πt
    
    -- Combat
    CombatEnabled = true,
    AttacksPerTarget = 3,
    HitDelay = 0.05,
    
    -- N√¢ng cao
    StayOnHead = true, -- ƒê·ª©ng tr√™n ƒë·∫ßu qu√°i
    AutoAdjustHeight = true, -- T·ª± ƒëi·ªÅu ch·ªânh ƒë·ªô cao
    DebugMode = false,
    
    -- T√≠nh nƒÉng m·ªõi
    GomQuai = true, -- Gom qu√°i v√†o 1 ch·ªó
    GomRadius = 30, -- B√°n k√≠nh gom qu√°i
    MaxGomTargets = 4, -- S·ªë l∆∞·ª£ng qu√°i t·ªëi ƒëa ƒë·ªÉ gom
    RainbowGUI = false -- Hi·ªáu ·ª©ng c·∫ßu v·ªìng cho GUI (b·∫≠t/t·∫Øt b·∫±ng logo MB)
}

-- ==================== BI·∫æN ====================
local farmConnection = nil
local flyConnection = nil
local noclipConnection = nil
local rainbowConnection = nil
local rainbowLogoConnection = nil
local currentTarget = nil
local targetsList = {}
local gomTargets = {} -- Danh s√°ch qu√°i ƒëang gom
local isFlyingToTarget = false
local isOnHead = false
local isGomming = false -- ƒêang trong qu√° tr√¨nh gom qu√°i
local totalKills = 0
local startTime = os.time()
local lastScanTime = 0
local isWaitingForTarget = false

-- Bi·∫øn xuy√™n t∆∞·ªùng
local noclipParts = {}
local originalCanCollide = {}

-- Bi·∫øn GUI
local MainFrame, Title, StatusLabel, KillsLabel, SpeedLabel, NoClipLabel, GomQuaiLabel
local StartBtn, StopBtn, TargetList, NoClipToggleBtn, SpeedUpBtn, SpeedDownBtn, GomQuaiToggleBtn
local MBBLogo, MBBLogoFrame -- Logo MB

-- Module Combat
local Net = ReplicatedStorage:FindFirstChild("Modules") and ReplicatedStorage.Modules:FindFirstChild("Net")
local RegisterAttack = Net and Net:WaitForChild("RE/RegisterAttack", 5)
local RegisterHit = Net and Net:WaitForChild("RE/RegisterHit", 5)

-- ==================== HI·ªÜU ·ª®NG RAINBOW CHO GUI ====================
function StartRainbowGUI()
    if rainbowConnection then
        rainbowConnection:Disconnect()
    end
    
    local hue = 0
    rainbowConnection = RunService.Heartbeat:Connect(function()
        if not MainFrame then return end
        
        hue = (hue + 0.01) % 1
        local color = Color3.fromHSV(hue, 0.7, 0.7)
        
        -- Thay ƒë·ªïi m√†u n·ªÅn ch√≠nh
        MainFrame.BackgroundColor3 = color
        
        -- Thay ƒë·ªïi m√†u ti√™u ƒë·ªÅ
        if Title then
            Title.TextColor3 = Color3.fromHSV((hue + 0.5) % 1, 0.9, 1)
        end
        
        -- Thay ƒë·ªïi m√†u c√°c n√∫t
        if StartBtn then
            StartBtn.BackgroundColor3 = Color3.fromHSV((hue + 0.2) % 1, 0.8, 0.6)
        end
        if StopBtn then
            StopBtn.BackgroundColor3 = Color3.fromHSV((hue + 0.3) % 1, 0.8, 0.6)
        end
        if NoClipToggleBtn then
            NoClipToggleBtn.BackgroundColor3 = Color3.fromHSV((hue + 0.4) % 1, 0.8, 0.6)
        end
        if GomQuaiToggleBtn then
            GomQuaiToggleBtn.BackgroundColor3 = Color3.fromHSV((hue + 0.5) % 1, 0.8, 0.6)
        end
        
        -- Thay ƒë·ªïi m√†u danh s√°ch qu√°i
        if TargetList then
            TargetList.TextColor3 = Color3.fromHSV((hue + 0.6) % 1, 0.6, 0.9)
        end
    end)
    
    Config.RainbowGUI = true
    if MBBLogo then
        MBBLogo.Text = "MB üåà"
    end
    print("[RAINBOW] ƒê√£ b·∫≠t hi·ªáu ·ª©ng c·∫ßu v·ªìng cho GUI")
end

function StopRainbowGUI()
    if rainbowConnection then
        rainbowConnection:Disconnect()
        rainbowConnection = nil
    end
    
    -- Kh√¥i ph·ª•c m√†u m·∫∑c ƒë·ªãnh
    if MainFrame then
        MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    end
    if Title then
        Title.TextColor3 = Color3.fromRGB(255, 100, 100)
    end
    if StartBtn then
        StartBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
    end
    if StopBtn then
        StopBtn.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
    end
    if NoClipToggleBtn then
        NoClipToggleBtn.BackgroundColor3 = Config.NoClip and Color3.fromRGB(200, 0, 0) or Color3.fromRGB(0, 150, 0)
    end
    if GomQuaiToggleBtn then
        GomQuaiToggleBtn.BackgroundColor3 = Config.GomQuai and Color3.fromRGB(200, 0, 0) or Color3.fromRGB(0, 150, 0)
    end
    if TargetList then
        TargetList.TextColor3 = Color3.fromRGB(200, 200, 200)
    end
    
    Config.RainbowGUI = false
    if MBBLogo then
        MBBLogo.Text = "MB"
    end
    print("[RAINBOW] ƒê√£ t·∫Øt hi·ªáu ·ª©ng c·∫ßu v·ªìng cho GUI")
end

function ToggleRainbowGUI()
    if Config.RainbowGUI then
        StopRainbowGUI()
    else
        StartRainbowGUI()
    end
end

-- ==================== HI·ªÜU ·ª®NG RAINBOW CHO LOGO MB ====================
function StartRainbowLogo()
    if rainbowLogoConnection then
        rainbowLogoConnection:Disconnect()
    end
    
    local hue = 0
    rainbowLogoConnection = RunService.Heartbeat:Connect(function()
        if not MBBLogo then return end
        
        hue = (hue + 0.05) % 1
        MBBLogo.TextColor3 = Color3.fromHSV(hue, 1, 1)
    end)
end

function StopRainbowLogo()
    if rainbowLogoConnection then
        rainbowLogoConnection:Disconnect()
        rainbowLogoConnection = nil
    end
end

-- ==================== LOGO MB ====================
function CreateMBLogo()
    local logoGui = Instance.new("ScreenGui")
    logoGui.Name = "MBLogoGUI"
    logoGui.Parent = player.PlayerGui
    logoGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    MBBLogoFrame = Instance.new("Frame")
    MBBLogoFrame.Size = UDim2.new(0, 60, 0, 60)
    MBBLogoFrame.Position = UDim2.new(1, -70, 0, 10)
    MBBLogoFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    MBBLogoFrame.BackgroundTransparency = 0.3
    MBBLogoFrame.Active = true
    MBBLogoFrame.Draggable = true
    MBBLogoFrame.Parent = logoGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = MBBLogoFrame
    
    MBBLogo = Instance.new("TextButton")
    MBBLogo.Text = "MB"
    MBBLogo.Size = UDim2.new(1, 0, 1, 0)
    MBBLogo.BackgroundTransparency = 1
    MBBLogo.TextColor3 = Color3.fromRGB(255, 255, 255)
    MBBLogo.Font = Enum.Font.GothamBlack
    MBBLogo.TextSize = 24
    MBBLogo.TextScaled = false
    MBBLogo.Parent = MBBLogoFrame
    
    -- B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng rainbow cho logo
    StartRainbowLogo()
    
    -- S·ª± ki·ªán click v√†o logo
    MBBLogo.MouseButton1Click:Connect(function()
        if MainFrame then
            local isVisible = MainFrame.Visible
            MainFrame.Visible = not isVisible
            
            if not isVisible then
                -- Khi hi·ªán GUI, b·∫≠t rainbow n·∫øu ƒëang b·∫≠t
                if Config.RainbowGUI then
                    StartRainbowGUI()
                end
                print("[LOGO] ƒê√£ hi·ªán GUI")
            else
                -- Khi ·∫©n GUI, t·∫Øt rainbow
                StopRainbowGUI()
                print("[LOGO] ƒê√£ ·∫©n GUI")
            end
            
            -- Th√¥ng b√°o tr√™n logo
            MBBLogo.Text = not isVisible and "MB" .. (Config.RainbowGUI and " üåà" or "") or "MB"
        end
    end)
    
    -- Double click ƒë·ªÉ b·∫≠t/t·∫Øt rainbow GUI
    local lastClickTime = 0
    MBBLogo.MouseButton1Down:Connect(function()
        local currentTime = tick()
        if currentTime - lastClickTime < 0.5 then
            -- Double click
            ToggleRainbowGUI()
            MBBLogo.Text = "MB" .. (Config.RainbowGUI and " üåà" or "")
        end
        lastClickTime = currentTime
    end)
    
    -- Tooltip
    local tooltip = Instance.new("TextLabel")
    tooltip.Text = "Click: ·∫®n/Hi·ªán GUI\nDouble Click: B·∫≠t/T·∫Øt Rainbow"
    tooltip.Size = UDim2.new(0, 150, 0, 40)
    tooltip.Position = UDim2.new(0, 70, 0, 10)
    tooltip.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    tooltip.BackgroundTransparency = 0.7
    tooltip.TextColor3 = Color3.fromRGB(255, 255, 255)
    tooltip.Font = Enum.Font.Gotham
    tooltip.TextSize = 12
    tooltip.TextWrapped = true
    tooltip.Visible = false
    tooltip.Parent = MBBLogoFrame
    
    local tooltipCorner = Instance.new("UICorner")
    tooltipCorner.CornerRadius = UDim.new(0, 6)
    tooltipCorner.Parent = tooltip
    
    -- Hi·ªán tooltip khi hover
    MBBLogo.MouseEnter:Connect(function()
        tooltip.Visible = true
    end)
    
    MBBLogo.MouseLeave:Connect(function()
        tooltip.Visible = false
    end)
    
    return logoGui
end

function CleanupLogo()
    StopRainbowLogo()
    local logoGui = player.PlayerGui:FindFirstChild("MBLogoGUI")
    if logoGui then
        logoGui:Destroy()
    end
end

-- ==================== H√ÄM XUY√äN T∆Ø·ªúNG ====================
function EnableNoClip()
    if not Config.NoClip then return end
    
    -- L∆∞u l·∫°i v√† t·∫Øt CanCollide c·ªßa t·∫•t c·∫£ part trong nh√¢n v·∫≠t
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            originalCanCollide[part] = part.CanCollide
            part.CanCollide = false
            table.insert(noclipParts, part)
        end
    end
    
    -- K·∫øt n·ªëi ƒë·ªÉ duy tr√¨ NoClip
    if noclipConnection then
        noclipConnection:Disconnect()
    end
    
    noclipConnection = RunService.Stepped:Connect(function()
        if not character then
            noclipConnection:Disconnect()
            return
        end
        
        for _, part in pairs(noclipParts) do
            if part and part.Parent then
                part.CanCollide = false
            end
        end
    end)
    
    print("[NO CLIP] ƒê√£ b·∫≠t xuy√™n t∆∞·ªùng")
end

function DisableNoClip()
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    -- Kh√¥i ph·ª•c CanCollide g·ªëc
    for part, canCollide in pairs(originalCanCollide) do
        if part and part.Parent then
            part.CanCollide = canCollide
        end
    end
    
    noclipParts = {}
    originalCanCollide = {}
    
    print("[NO CLIP] ƒê√£ t·∫Øt xuy√™n t∆∞·ªùng")
end

function ToggleNoClip()
    Config.NoClip = not Config.NoClip
    
    if Config.NoClip then
        EnableNoClip()
        if NoClipLabel then
            NoClipLabel.Text = "Xuy√™n t∆∞·ªùng: B·∫¨T"
            NoClipLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        end
        if NoClipToggleBtn then
            NoClipToggleBtn.Text = "üö´ T·∫ÆT XUY√äN T∆Ø·ªúNG"
            NoClipToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        end
    else
        DisableNoClip()
        if NoClipLabel then
            NoClipLabel.Text = "Xuy√™n t∆∞·ªùng: T·∫ÆT"
            NoClipLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
        if NoClipToggleBtn then
            NoClipToggleBtn.Text = "üöÄ B·∫¨T XUY√äN T∆Ø·ªúNG"
            NoClipToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        end
    end
end

-- ==================== H√ÄM GOM QU√ÅI ====================
function GomQuaiToPosition(position)
    if not Config.GomQuai or isGomming then return end
    
    isGomming = true
    print("[GOM QU√ÅI] B·∫Øt ƒë·∫ßu gom qu√°i v√†o v·ªã tr√≠...")
    
    -- T√¨m c√°c qu√°i trong b√°n k√≠nh
    local foundTargets = {}
    local charPos = position or humanoidRootPart.Position
    
    -- Qu√©t trong Workspace
    for _, npc in pairs(Workspace:GetChildren()) do
        if IsValidNPC(npc) then
            local rootPart = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("PrimaryPart")
            if rootPart then
                local distance = (rootPart.Position - charPos).Magnitude
                if distance <= Config.GomRadius * 2 then -- T√¨m trong b√°n k√≠nh r·ªông h∆°n
                    table.insert(foundTargets, {
                        model = npc,
                        rootPart = rootPart,
                        distance = distance
                    })
                end
            end
        end
    end
    
    -- Qu√©t trong folder Enemies
    local enemiesFolder = Workspace:FindFirstChild("Enemies")
    if enemiesFolder then
        for _, npc in pairs(enemiesFolder:GetChildren()) do
            if IsValidNPC(npc) then
                local rootPart = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("PrimaryPart")
                if rootPart then
                    local distance = (rootPart.Position - charPos).Magnitude
                    if distance <= Config.GomRadius * 2 then
                        table.insert(foundTargets, {
                            model = npc,
                            rootPart = rootPart,
                            distance = distance
                        })
                    end
                end
            end
        end
    end
    
    -- S·∫Øp x·∫øp theo kho·∫£ng c√°ch
    table.sort(foundTargets, function(a, b)
        return a.distance < b.distance
    end)
    
    -- Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng
    if #foundTargets > Config.MaxGomTargets then
        for i = Config.MaxGomTargets + 1, #foundTargets do
            foundTargets[i] = nil
        end
    end
    
    -- L∆∞u danh s√°ch qu√°i c·∫ßn gom
    gomTargets = foundTargets
    
    -- Gom t·ª´ng con qu√°i v·ªÅ v·ªã tr√≠
    for i, target in ipairs(gomTargets) do
        if target and target.model and target.rootPart then
            local npcHumanoid = target.model:FindFirstChildOfClass("Humanoid")
            if npcHumanoid and npcHumanoid.Health > 0 then
                print(string.format("[GOM QU√ÅI] ƒêang gom qu√°i %d/%d: %s", i, #gomTargets, target.model.Name))
                
                -- T√≠nh v·ªã tr√≠ xung quanh player
                local angle = (i / #gomTargets) * math.pi * 2
                local offset = Vector3.new(math.cos(angle) * 10, 0, math.sin(angle) * 10)
                local targetPosition = (position or humanoidRootPart.Position) + offset
                
                -- Di chuy·ªÉn qu√°i v·ªÅ v·ªã tr√≠ (gi·∫£ l·∫≠p)
                task.spawn(function()
                    local startTime = tick()
                    while tick() - startTime < 3 do -- Th·ªùi gian t·ªëi ƒëa 3 gi√¢y
                        if not target.model or not target.rootPart then break end
                        if npcHumanoid.Health <= 0 then break end
                        
                        -- ƒê·∫©y qu√°i v·ªÅ ph√≠a v·ªã tr√≠
                        local direction = (targetPosition - target.rootPart.Position).Unit
                        target.rootPart.Velocity = direction * 30
                        
                        task.wait(0.1)
                    end
                end)
            end
        end
    end
    
    task.wait(2) -- Ch·ªù 2 gi√¢y ƒë·ªÉ qu√°i ƒë∆∞·ª£c gom
    isGomming = false
    print(string.format("[GOM QU√ÅI] ƒê√£ gom xong %d qu√°i", #gomTargets))
end

function ToggleGomQuai()
    Config.GomQuai = not Config.GomQuai
    
    if Config.GomQuai then
        if GomQuaiLabel then
            GomQuaiLabel.Text = "Gom qu√°i: B·∫¨T"
            GomQuaiLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        end
        if GomQuaiToggleBtn then
            GomQuaiToggleBtn.Text = "üö´ T·∫ÆT GOM QU√ÅI"
            GomQuaiToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        end
    else
        if GomQuaiLabel then
            GomQuaiLabel.Text = "Gom qu√°i: T·∫ÆT"
            GomQuaiLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
        if GomQuaiToggleBtn then
            GomQuaiToggleBtn.Text = "üåÄ B·∫¨T GOM QU√ÅI"
            GomQuaiToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        end
    end
    
    print("[GOM QU√ÅI] " .. (Config.GomQuai and "B·∫¨T" or "T·∫ÆT"))
end

-- ==================== H√ÄM QU√âT QU√ÅI ====================
function IsValidNPC(npc)
    if not npc then return false end
    if not npc:IsA("Model") then return false end
    
    local humanoid = npc:FindFirstChildOfClass("Humanoid")
    local rootPart = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("PrimaryPart")
    
    if not humanoid or not rootPart then return false end
    if humanoid.Health <= 0 then return false end
    
    -- Ki·ªÉm tra xem c√≥ ph·∫£i l√† qu√°i kh√¥ng
    local isEnemy = false
    local npcName = npc.Name:lower()
    
    local enemyKeywords = {
        "bandit", "monkey", "gorilla", "pirate", "brute",
        "marine", "soldier", "guard", "enemy", "mob",
        "zombie", "skeleton", "creature", "beast", "monster",
        "knight", "assassin", "archer", "mage", "boss"
    }
    
    for _, keyword in pairs(enemyKeywords) do
        if string.find(npcName, keyword) then
            isEnemy = true
            break
        end
    end
    
    -- Ki·ªÉm tra folder
    local parent = npc.Parent
    if parent and (parent.Name == "Enemies" or parent.Name == "NPCs" or parent.Name:find("Enemy")) then
        isEnemy = true
    end
    
    return isEnemy
end

function ScanForTargets()
    local foundTargets = {}
    local charPos = humanoidRootPart.Position
    
    -- Qu√©t trong Workspace
    for _, npc in pairs(Workspace:GetChildren()) do
        if IsValidNPC(npc) then
            local rootPart = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("PrimaryPart")
            if rootPart then
                local distance = (rootPart.Position - charPos).Magnitude
                if distance <= Config.ScanRange then
                    table.insert(foundTargets, {
                        model = npc,
                        rootPart = rootPart,
                        distance = distance,
                        health = npc:FindFirstChildOfClass("Humanoid").Health,
                        maxHealth = npc:FindFirstChildOfClass("Humanoid").MaxHealth
                    })
                end
            end
        end
    end
    
    -- Qu√©t trong folder Enemies (n·∫øu c√≥)
    local enemiesFolder = Workspace:FindFirstChild("Enemies")
    if enemiesFolder then
        for _, npc in pairs(enemiesFolder:GetChildren()) do
            if IsValidNPC(npc) then
                local rootPart = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("PrimaryPart")
                if rootPart then
                    local distance = (rootPart.Position - charPos).Magnitude
                    if distance <= Config.ScanRange then
                        table.insert(foundTargets, {
                            model = npc,
                            rootPart = rootPart,
                            distance = distance,
                            health = npc:FindFirstChildOfClass("Humanoid").Health,
                            maxHealth = npc:FindFirstChildOfClass("Humanoid").MaxHealth
                        })
                    end
                end
            end
        end
    end
    
    -- S·∫Øp x·∫øp theo kho·∫£ng c√°ch
    table.sort(foundTargets, function(a, b)
        return a.distance < b.distance
    end)
    
    -- Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng
    if #foundTargets > Config.MaxTargets then
        for i = Config.MaxTargets + 1, #foundTargets do
            foundTargets[i] = nil
        end
    end
    
    return foundTargets
end

function GetBestTarget()
    if #targetsList == 0 then
        targetsList = ScanForTargets()
    end
    
    -- T√¨m qu√°i c√≤n s·ªëng ƒë·∫ßu ti√™n trong danh s√°ch
    for i = 1, #targetsList do
        local target = targetsList[i]
        if target and target.model and target.model.Parent then
            local humanoid = target.model:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                return target
            else
                -- Qu√°i ƒë√£ ch·∫øt, x√≥a kh·ªèi danh s√°ch
                table.remove(targetsList, i)
                return GetBestTarget()
            end
        else
            -- Qu√°i kh√¥ng c√≤n t·ªìn t·∫°i
            table.remove(targetsList, i)
            return GetBestTarget()
        end
    end
    
    -- N·∫øu kh√¥ng t√¨m th·∫•y, qu√©t l·∫°i
    targetsList = ScanForTargets()
    return GetBestTarget()
end

-- ==================== H√ÄM BAY ====================
function FlyToTarget(targetPosition)
    if not Config.UseFly or isFlyingToTarget then return end
    
    isFlyingToTarget = true
    isOnHead = false
    print("[AUTO FARM] ƒêang bay ƒë·∫øn m·ª•c ti√™u v·ªõi t·ªëc ƒë·ªô " .. Config.CurrentSpeed .. "...")
    
    local targetPos = targetPosition + Vector3.new(0, Config.FlyHeight, 0)
    
    if flyConnection then
        flyConnection:Disconnect()
    end
    
    flyConnection = RunService.Heartbeat:Connect(function()
        if not Config.Enabled or not character or humanoid.Health <= 0 then
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            isFlyingToTarget = false
            return
        end
        
        local currentPos = humanoidRootPart.Position
        local direction = (targetPos - currentPos).Unit
        local distance = (targetPos - currentPos).Magnitude
        
        if distance > 5 then
            local velocity = direction * Config.CurrentSpeed
            humanoidRootPart.Velocity = Vector3.new(velocity.X, velocity.Y, velocity.Z)
            
            -- ƒêi·ªÅu ch·ªânh ƒë·ªô cao n·∫øu c·∫ßn
            if Config.AutoAdjustHeight and currentTarget then
                local targetCurrentPos = currentTarget.rootPart.Position
                local desiredHeight = targetCurrentPos.Y + Config.FlyHeight
                local heightDiff = desiredHeight - currentPos.Y
                
                if math.abs(heightDiff) > 5 then
                    humanoidRootPart.Velocity = Vector3.new(velocity.X, heightDiff * 2, velocity.Z)
                end
            end
        else
            -- ƒê√£ ƒë·∫øn ƒë√≠ch
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            isFlyingToTarget = false
            isOnHead = true
            
            -- ƒê·ª©ng tr√™n ƒë·∫ßu qu√°i
            if Config.StayOnHead then
                StayOnTargetHead()
            end
            
            print("[AUTO FARM] ƒê√£ ƒë·∫øn m·ª•c ti√™u")
        end
    end)
end

function StayOnTargetHead()
    if not currentTarget or not Config.StayOnHead then return end
    
    if flyConnection then
        flyConnection:Disconnect()
    end
    
    flyConnection = RunService.Heartbeat:Connect(function()
        if not currentTarget or not currentTarget.model or not currentTarget.rootPart then
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            return
        end
        
        local targetHumanoid = currentTarget.model:FindFirstChildOfClass("Humanoid")
        if not targetHumanoid or targetHumanoid.Health <= 0 then
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            isOnHead = false
            return
        end
        
        -- Lu√¥n ƒë·ª©ng tr√™n ƒë·∫ßu qu√°i
        local targetPos = currentTarget.rootPart.Position
        local headPosition = targetPos + Vector3.new(0, Config.FlyHeight, 0)
        
        humanoidRootPart.CFrame = CFrame.new(headPosition)
        humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    end)
end

function ChangeSpeed(amount)
    local oldSpeed = Config.CurrentSpeed
    Config.CurrentSpeed = math.clamp(Config.CurrentSpeed + amount, 50, 250) -- Gi·ªõi h·∫°n t·ª´ 50-250
    
    if SpeedLabel then
        SpeedLabel.Text = "T·ªëc ƒë·ªô bay: " .. Config.CurrentSpeed
        if Config.CurrentSpeed == 250 then
            SpeedLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        elseif Config.CurrentSpeed >= 200 then
            SpeedLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        else
            SpeedLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
        end
    end
    
    if oldSpeed ~= Config.CurrentSpeed then
        print("[T·ªêC ƒê·ªò] ƒê√£ thay ƒë·ªïi: " .. Config.CurrentSpeed)
    end
end

-- ==================== H√ÄM COMBAT (ƒê√É TH√äM GOM QU√ÅI) ====================
function AttackTarget()
    if not Config.CombatEnabled then return false end
    
    if not currentTarget or not currentTarget.model or not currentTarget.rootPart then return false end
    
    local npcHumanoid = currentTarget.model:FindFirstChildOfClass("Humanoid")
    if not npcHumanoid or npcHumanoid.Health <= 0 then return false end
    
    print("[AUTO FARM] ƒêang t·∫•n c√¥ng: " .. currentTarget.model.Name)
    
    -- N·∫øu b·∫≠t gom qu√°i, gom qu√°i tr∆∞·ªõc khi ƒë√°nh
    if Config.GomQuai and not isGomming and #gomTargets == 0 then
        GomQuaiToPosition(currentTarget.rootPart.Position)
        task.wait(1) -- Ch·ªù 1 gi√¢y ƒë·ªÉ gom qu√°i
    end
    
    -- T·∫•n c√¥ng m·ª•c ti√™u ch√≠nh v√† c√°c qu√°i ƒë√£ gom
    local allTargets = {currentTarget}
    for _, target in ipairs(gomTargets) do
        if target and target.model and target.rootPart then
            local targetHumanoid = target.model:FindFirstChildOfClass("Humanoid")
            if targetHumanoid and targetHumanoid.Health > 0 then
                table.insert(allTargets, target)
            end
        end
    end
    
    -- T·∫•n c√¥ng t·∫•t c·∫£ c√°c m·ª•c ti√™u
    for i, target in ipairs(allTargets) do
        if i > Config.MaxGomTargets then break end -- Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng
        
        if target and target.model and target.rootPart then
            local targetHumanoid = target.model:FindFirstChildOfClass("Humanoid")
            if targetHumanoid and targetHumanoid.Health > 0 then
                print(string.format("[AUTO FARM] T·∫•n c√¥ng qu√°i %d: %s", i, target.model.Name))
                
                -- S·ª≠ d·ª•ng module combat n·∫øu c√≥
                if RegisterAttack and RegisterHit then
                    RegisterAttack:FireServer()
                    for j = 1, math.floor(Config.AttacksPerTarget / #allTargets) do
                        if targetHumanoid.Health > 0 then
                            RegisterHit:FireServer(target.rootPart)
                            task.wait(Config.HitDelay)
                        else
                            break
                        end
                    end
                else
                    -- T·∫•n c√¥ng tr·ª±c ti·∫øp
                    for j = 1, math.floor(Config.AttacksPerTarget / #allTargets) do
                        if targetHumanoid.Health > 0 then
                            targetHumanoid:TakeDamage(50)
                            task.wait(Config.HitDelay)
                        else
                            break
                        end
                    end
                end
                
                -- Ki·ªÉm tra n·∫øu qu√°i ch·∫øt
                if targetHumanoid.Health <= 0 then
                    totalKills = totalKills + 1
                    print("[AUTO FARM] ƒê√£ ti√™u di·ªát: " .. target.model.Name)
                    
                    -- X√≥a kh·ªèi danh s√°ch gom
                    for k, gomTarget in ipairs(gomTargets) do
                        if gomTarget.model == target.model then
                            table.remove(gomTargets, k)
                            break
                        end
                    end
                    
                    -- X√≥a kh·ªèi danh s√°ch ch√≠nh
                    for k, mainTarget in ipairs(targetsList) do
                        if mainTarget.model == target.model then
                            table.remove(targetsList, k)
                            break
                        end
                    end
                end
            end
        end
    end
    
    -- X√≥a danh s√°ch gom sau khi t·∫•n c√¥ng
    if #allTargets > 1 then
        print(string.format("[GOM QU√ÅI] ƒê√£ t·∫•n c√¥ng %d qu√°i c√πng l√∫c!", #allTargets))
        gomTargets = {} -- Reset danh s√°ch gom
    end
    
    return true
end

-- ==================== V√íNG L·∫∂P AUTO FARM ====================
function AutoFarmLoop()
    if not Config.Enabled or not character or humanoid.Health <= 0 then return end
    
    if currentTarget then
        -- Ki·ªÉm tra m·ª•c ti√™u hi·ªán t·∫°i
        local targetHumanoid = currentTarget.model:FindFirstChildOfClass("Humanoid")
        
        if not targetHumanoid or targetHumanoid.Health <= 0 then
            -- M·ª•c ti√™u ƒë√£ ch·∫øt
            print("[AUTO FARM] ƒê√£ ti√™u di·ªát: " .. currentTarget.model.Name)
            totalKills = totalKills + 1
            
            -- X√≥a m·ª•c ti√™u ƒë√£ ch·∫øt kh·ªèi danh s√°ch
            for i, target in ipairs(targetsList) do
                if target.model == currentTarget.model then
                    table.remove(targetsList, i)
                    break
                end
            end
            
            currentTarget = nil
            isOnHead = false
            isFlyingToTarget = false
            
            -- D·ª´ng bay
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            
            UpdateGUI()
            task.wait(Config.WaitAfterKill)
            -- KH√îNG RETURN ·ªû ƒê√ÇY! ƒê·ªÉ n√≥ ti·∫øp t·ª•c xu·ªëng d∆∞·ªõi t√¨m m·ª•c ti√™u m·ªõi
        else
            -- T√≠nh kho·∫£ng c√°ch ƒë·∫øn m·ª•c ti√™u
            local distance = (currentTarget.rootPart.Position - humanoidRootPart.Position).Magnitude
            
            if distance > Config.AttackRange then
                -- Bay ƒë·∫øn m·ª•c ti√™u n·∫øu c√≤n xa
                if not isFlyingToTarget then
                    FlyToTarget(currentTarget.rootPart.Position)
                end
            else
                -- ƒê√£ ƒë·∫øn g·∫ßn
                if Config.StayOnHead and not isOnHead then
                    StayOnTargetHead()
                end
                
                -- T·∫•n c√¥ng
                AttackTarget()
            end
        end
    end
    
    -- N·∫øu kh√¥ng c√≥ m·ª•c ti√™u hi·ªán t·∫°i (ho·∫∑c m·ª•c ti√™u v·ª´a ch·∫øt), t√¨m m·ª•c ti√™u m·ªõi
    if not currentTarget and not isWaitingForTarget then
        local currentTime = tick()
        
        -- Gi·ªõi h·∫°n t·∫ßn su·∫•t qu√©t (ch·ªâ qu√©t sau m·ªói 3 gi√¢y)
        if currentTime - lastScanTime >= 3 then
            isWaitingForTarget = true
            lastScanTime = currentTime
            
            -- T√¨m m·ª•c ti√™u m·ªõi
            currentTarget = GetBestTarget()
            if currentTarget then
                print("[AUTO FARM] ƒê√£ t√¨m th·∫•y m·ª•c ti√™u: " .. currentTarget.model.Name)
                UpdateGUI()
                -- T·ª± ƒë·ªông bay ƒë·∫øn m·ª•c ti√™u m·ªõi
                if Config.UseFly then
                    FlyToTarget(currentTarget.rootPart.Position)
                end
                isWaitingForTarget = false
            else
                print("[AUTO FARM] Kh√¥ng t√¨m th·∫•y qu√°i trong ph·∫°m vi. ƒêang ch·ªù...")
                -- ƒê·ª£i 3 gi√¢y tr∆∞·ªõc khi qu√©t l·∫°i
                task.wait(3)
                isWaitingForTarget = false
            end
        end
    end
end

-- ==================== GUI ====================
function CreateGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AutoFarmGUI"
    ScreenGui.Parent = player.PlayerGui
    
    -- Khung ch√≠nh
    MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 500, 0, 600)
    MainFrame.Position = UDim2.new(0.5, -250, 0.5, -300)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    MainFrame.BackgroundTransparency = 0.1
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = MainFrame
    
    -- Ti√™u ƒë·ªÅ
    Title = Instance.new("TextLabel")
    Title.Text = "üöÄ AUTO FARM 5000 - T·ªëc ƒë·ªô 250 - by M·∫°c B√°ch üöÄ"
    Title.Size = UDim2.new(1, 0, 0, 45)
    Title.Position = UDim2.new(0, 0, 0, 10)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.fromRGB(255, 100, 100)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    Title.TextStrokeTransparency = 0.5
    Title.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    Title.Parent = MainFrame
    
    -- Th√¥ng tin
    StatusLabel = Instance.new("TextLabel")
    StatusLabel.Text = "Tr·∫°ng th√°i: ƒêang t·∫Øt"
    StatusLabel.Size = UDim2.new(1, -20, 0, 25)
    StatusLabel.Position = UDim2.new(0, 10, 0, 65)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.TextColor3 = Color3.fromRGB(150, 255, 150)
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.TextSize = 14
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    StatusLabel.Parent = MainFrame
    
    KillsLabel = Instance.new("TextLabel")
    KillsLabel.Text = "S·ªë qu√°i ƒë√£ di·ªát: 0"
    KillsLabel.Size = UDim2.new(1, -20, 0, 25)
    KillsLabel.Position = UDim2.new(0, 10, 0, 90)
    KillsLabel.BackgroundTransparency = 1
    KillsLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    KillsLabel.Font = Enum.Font.Gotham
    KillsLabel.TextSize = 14
    KillsLabel.TextXAlignment = Enum.TextXAlignment.Left
    KillsLabel.Parent = MainFrame
    
    SpeedLabel = Instance.new("TextLabel")
    SpeedLabel.Text = "T·ªëc ƒë·ªô bay: " .. Config.CurrentSpeed
    SpeedLabel.Size = UDim2.new(1, -20, 0, 25)
    SpeedLabel.Position = UDim2.new(0, 10, 0, 115)
    SpeedLabel.BackgroundTransparency = 1
    SpeedLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    SpeedLabel.Font = Enum.Font.Gotham
    SpeedLabel.TextSize = 14
    SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
    SpeedLabel.Parent = MainFrame
    
    NoClipLabel = Instance.new("TextLabel")
    NoClipLabel.Text = Config.NoClip and "Xuy√™n t∆∞·ªùng: B·∫¨T" or "Xuy√™n t∆∞·ªùng: T·∫ÆT"
    NoClipLabel.Size = UDim2.new(1, -20, 0, 25)
    NoClipLabel.Position = UDim2.new(0, 10, 0, 140)
    NoClipLabel.BackgroundTransparency = 1
    NoClipLabel.TextColor3 = Config.NoClip and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    NoClipLabel.Font = Enum.Font.Gotham
    NoClipLabel.TextSize = 14
    NoClipLabel.TextXAlignment = Enum.TextXAlignment.Left
    NoClipLabel.Parent = MainFrame
    
    GomQuaiLabel = Instance.new("TextLabel")
    GomQuaiLabel.Text = Config.GomQuai and "Gom qu√°i: B·∫¨T" or "Gom qu√°i: T·∫ÆT"
    GomQuaiLabel.Size = UDim2.new(1, -20, 0, 25)
    GomQuaiLabel.Position = UDim2.new(0, 10, 0, 165)
    GomQuaiLabel.BackgroundTransparency = 1
    GomQuaiLabel.TextColor3 = Config.GomQuai and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    GomQuaiLabel.Font = Enum.Font.Gotham
    GomQuaiLabel.TextSize = 14
    GomQuaiLabel.TextXAlignment = Enum.TextXAlignment.Left
    GomQuaiLabel.Parent = MainFrame
    
    -- N√∫t ƒëi·ªÅu khi·ªÉn ch√≠nh
    StartBtn = Instance.new("TextButton")
    StartBtn.Text = "‚ñ∂ B·∫¨T AUTO FARM"
    StartBtn.Size = UDim2.new(0.9, 0, 0, 50)
    StartBtn.Position = UDim2.new(0.05, 0, 0.25, 0)
    StartBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
    StartBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    StartBtn.Font = Enum.Font.GothamBold
    StartBtn.TextSize = 16
    
    local startCorner = Instance.new("UICorner")
    startCorner.CornerRadius = UDim.new(0, 8)
    startCorner.Parent = StartBtn
    
    StartBtn.Parent = MainFrame
    
    StopBtn = Instance.new("TextButton")
    StopBtn.Text = "‚è∏ D·ª™NG AUTO FARM"
    StopBtn.Size = UDim2.new(0.9, 0, 0, 50)
    StopBtn.Position = UDim2.new(0.05, 0, 0.35, 0)
    StopBtn.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
    StopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    StopBtn.Font = Enum.Font.GothamBold
    StopBtn.TextSize = 16
    StopBtn.Visible = false
    
    local stopCorner = Instance.new("UICorner")
    stopCorner.CornerRadius = UDim.new(0, 8)
    stopCorner.Parent = StopBtn
    
    StopBtn.Parent = MainFrame
    
    -- N√∫t xuy√™n t∆∞·ªùng
    NoClipToggleBtn = Instance.new("TextButton")
    NoClipToggleBtn.Text = Config.NoClip and "üö´ T·∫ÆT XUY√äN T∆Ø·ªúNG" or "üöÄ B·∫¨T XUY√äN T∆Ø·ªúNG"
    NoClipToggleBtn.Size = UDim2.new(0.43, 0, 0, 40)
    NoClipToggleBtn.Position = UDim2.new(0.05, 0, 0.45, 0)
    NoClipToggleBtn.BackgroundColor3 = Config.NoClip and Color3.fromRGB(200, 0, 0) or Color3.fromRGB(0, 150, 0)
    NoClipToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    NoClipToggleBtn.Font = Enum.Font.GothamBold
    NoClipToggleBtn.TextSize = 12
    
    local noclipCorner = Instance.new("UICorner")
    noclipCorner.CornerRadius = UDim.new(0, 8)
    noclipCorner.Parent = NoClipToggleBtn
    
    NoClipToggleBtn.Parent = MainFrame
    
    -- N√∫t gom qu√°i
    GomQuaiToggleBtn = Instance.new("TextButton")
    GomQuaiToggleBtn.Text = Config.GomQuai and "üö´ T·∫ÆT GOM QU√ÅI" or "üåÄ B·∫¨T GOM QU√ÅI"
    GomQuaiToggleBtn.Size = UDim2.new(0.43, 0, 0, 40)
    GomQuaiToggleBtn.Position = UDim2.new(0.52, 0, 0.45, 0)
    GomQuaiToggleBtn.BackgroundColor3 = Config.GomQuai and Color3.fromRGB(200, 0, 0) or Color3.fromRGB(0, 150, 0)
    GomQuaiToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    GomQuaiToggleBtn.Font = Enum.Font.GothamBold
    GomQuaiToggleBtn.TextSize = 12
    
    local gomquaiCorner = Instance.new("UICorner")
    gomquaiCorner.CornerRadius = UDim.new(0, 8)
    gomquaiCorner.Parent = GomQuaiToggleBtn
    
    GomQuaiToggleBtn.Parent = MainFrame
    
    -- N√∫t ƒëi·ªÅu ch·ªânh t·ªëc ƒë·ªô
    SpeedUpBtn = Instance.new("TextButton")
    SpeedUpBtn.Text = "üìà TƒÇNG T·ªêC +10"
    SpeedUpBtn.Size = UDim2.new(0.43, 0, 0, 35)
    SpeedUpBtn.Position = UDim2.new(0.05, 0, 0.55, 0)
    SpeedUpBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 150)
    SpeedUpBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    SpeedUpBtn.Font = Enum.Font.Gotham
    SpeedUpBtn.TextSize = 12
    
    local speedUpCorner = Instance.new("UICorner")
    speedUpCorner.CornerRadius = UDim.new(0, 6)
    speedUpCorner.Parent = SpeedUpBtn
    
    SpeedUpBtn.Parent = MainFrame
    
    SpeedDownBtn = Instance.new("TextButton")
    SpeedDownBtn.Text = "üìâ GI·∫¢M T·ªêC -10"
    SpeedDownBtn.Size = UDim2.new(0.43, 0, 0, 35)
    SpeedDownBtn.Position = UDim2.new(0.52, 0, 0.55, 0)
    SpeedDownBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 150)
    SpeedDownBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    SpeedDownBtn.Font = Enum.Font.Gotham
    SpeedDownBtn.TextSize = 12
    
    local speedDownCorner = Instance.new("UICorner")
    speedDownCorner.CornerRadius = UDim.new(0, 6)
    speedDownCorner.Parent = SpeedDownBtn
    
    SpeedDownBtn.Parent = MainFrame
    
    -- Danh s√°ch m·ª•c ti√™u
    local targetsTitle = Instance.new("TextLabel")
    targetsTitle.Text = "üéØ DANH S√ÅCH QU√ÅI TRONG PH·∫†M VI 5000"
    targetsTitle.Size = UDim2.new(1, -20, 0, 30)
    targetsTitle.Position = UDim2.new(0, 10, 0.65, 0)
    targetsTitle.BackgroundTransparency = 1
    targetsTitle.TextColor3 = Color3.fromRGB(255, 200, 100)
    targetsTitle.Font = Enum.Font.GothamBold
    targetsTitle.TextSize = 14
    targetsTitle.TextXAlignment = Enum.TextXAlignment.Left
    targetsTitle.Parent = MainFrame
    
    -- Frame ch·ª©a danh s√°ch
    local listFrame = Instance.new("Frame")
    listFrame.Size = UDim2.new(1, -20, 0, 200)
    listFrame.Position = UDim2.new(0, 10, 0.7, 0)
    listFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    listFrame.BorderSizePixel = 0
    
    local listCorner = Instance.new("UICorner")
    listCorner.CornerRadius = UDim.new(0, 8)
    listCorner.Parent = listFrame
    
    listFrame.Parent = MainFrame
    
    -- Scrolling frame
    local scrollingFrame = Instance.new("ScrollingFrame")
    scrollingFrame.Size = UDim2.new(1, 0, 1, 0)
    scrollingFrame.BackgroundTransparency = 1
    scrollingFrame.BorderSizePixel = 0
    scrollingFrame.ScrollBarThickness = 6
    scrollingFrame.Parent = listFrame
    
    TargetList = Instance.new("TextLabel")
    TargetList.Text = "ƒêang qu√©t..."
    TargetList.Size = UDim2.new(1, -10, 0, 30)
    TargetList.Position = UDim2.new(0, 5, 0, 5)
    TargetList.BackgroundTransparency = 1
    TargetList.TextColor3 = Color3.fromRGB(200, 200, 200)
    TargetList.Font = Enum.Font.Gotham
    TargetList.TextSize = 12
    TargetList.TextXAlignment = Enum.TextXAlignment.Left
    TargetList.TextYAlignment = Enum.TextYAlignment.Top
    TargetList.TextWrapped = true
    TargetList.Parent = scrollingFrame
    
    -- H∆∞·ªõng d·∫´n
    local helpLabel = Instance.new("TextLabel")
    helpLabel.Text = "üìå Auto Farm s·∫Ω t·ª± ƒë·ªông qu√©t qu√°i trong 5000 studs,\nbay ƒë·∫øn t·ª´ng con v√† ƒë√°nh ch·∫øt.\n\n‚ö° T·ªëc ƒë·ªô m·∫∑c ƒë·ªãnh: 250 | Xuy√™n t∆∞·ªùng: " .. (Config.NoClip and "B·∫¨T" or "T·∫ÆT") .. "\nüåÄ Gom qu√°i: " .. (Config.GomQuai and "B·∫¨T" or "T·∫ÆT") .. "\nüåà Logo MB: ·∫®n/Hi·ªán GUI & B·∫≠t/T·∫Øt Rainbow"
    helpLabel.Size = UDim2.new(1, -20, 0, 90)
    helpLabel.Position = UDim2.new(0, 10, 0.95, -95)
    helpLabel.BackgroundTransparency = 1
    helpLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    helpLabel.Font = Enum.Font.Gotham
    helpLabel.TextSize = 12
    helpLabel.TextXAlignment = Enum.TextXAlignment.Left
    helpLabel.TextWrapped = true
    helpLabel.Parent = MainFrame
    
    return ScreenGui
end

function UpdateGUI()
    if StatusLabel then
        if Config.Enabled then
            StatusLabel.Text = "Tr·∫°ng th√°i: ƒêang ch·∫°y"
            StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            
            if currentTarget then
                local hpPercent = math.floor((currentTarget.health / currentTarget.maxHealth) * 100)
                StatusLabel.Text = StatusLabel.Text .. "\nM·ª•c ti√™u: " .. currentTarget.model.Name .. 
                                  " (HP: " .. hpPercent .. "%)"
            end
        else
            StatusLabel.Text = "Tr·∫°ng th√°i: ƒêang t·∫Øt"
            StatusLabel.TextColor3 = Color3.fromRGB(150, 255, 150)
        end
    end
    
    if KillsLabel then
        KillsLabel.Text = "S·ªë qu√°i ƒë√£ di·ªát: " .. totalKills
    end
    
    if SpeedLabel then
        SpeedLabel.Text = "T·ªëc ƒë·ªô bay: " .. Config.CurrentSpeed
        if Config.CurrentSpeed == 250 then
            SpeedLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        elseif Config.CurrentSpeed >= 200 then
            SpeedLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        else
            SpeedLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
        end
    end
    
    if NoClipLabel then
        NoClipLabel.Text = Config.NoClip and "Xuy√™n t∆∞·ªùng: B·∫¨T" or "Xuy√™n t∆∞·ªùng: T·∫ÆT"
        NoClipLabel.TextColor3 = Config.NoClip and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    end
    
    if GomQuaiLabel then
        GomQuaiLabel.Text = Config.GomQuai and "Gom qu√°i: B·∫¨T" or "Gom qu√°i: T·∫ÆT"
        GomQuaiLabel.TextColor3 = Config.GomQuai and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(255, 100, 100)
    end
    
    -- C·∫≠p nh·∫≠t danh s√°ch qu√°i
    if TargetList then
        local targets = ScanForTargets()
        local listText = ""
        
        if #targets == 0 then
            listText = "‚ùå Kh√¥ng t√¨m th·∫•y qu√°i trong ph·∫°m vi"
        else
            for i = 1, math.min(#targets, 8) do
                local target = targets[i]
                local healthPercent = math.floor((target.health / target.maxHealth) * 100)
                local healthColor = healthPercent > 50 and "üü¢" or healthPercent > 20 and "üü°" or "üî¥"
                
                listText = listText .. string.format("%s %d. %s\n   HP: %d%% | Kho·∫£ng c√°ch: %.1f studs\n\n", 
                    healthColor, i, target.model.Name, healthPercent, target.distance)
            end
            
            if #targets > 8 then
                listText = listText .. string.format("... v√† %d qu√°i kh√°c", #targets - 8)
            end
        end
        
        TargetList.Text = listText
        TargetList.Size = UDim2.new(1, -10, 0, #targets * 40 + 50)
    end
end

-- ==================== ƒêI·ªÄU KHI·ªÇN ====================
function StartAutoFarm()
    Config.Enabled = true
    print("[AUTO FARM] ƒê√£ b·∫≠t Auto Farm")
    print("  - T·ªëc ƒë·ªô: " .. Config.CurrentSpeed)
    print("  - Xuy√™n t∆∞·ªùng: " .. (Config.NoClip and "B·∫¨T" or "T·∫ÆT"))
    print("  - Gom qu√°i: " .. (Config.GomQuai and "B·∫¨T" or "T·∫ÆT"))
    
    StartBtn.Visible = false
    StopBtn.Visible = true
    
    -- Reset bi·∫øn th·ªùi gian
    lastScanTime = tick() - 3
    isWaitingForTarget = false
    
    -- B·∫≠t xuy√™n t∆∞·ªùng n·∫øu ƒë∆∞·ª£c c·∫•u h√¨nh
    if Config.NoClip then
        EnableNoClip()
    end
    
    UpdateGUI()
    
    -- B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
    if farmConnection then
        farmConnection:Disconnect()
    end
    
    farmConnection = RunService.Heartbeat:Connect(function()
        AutoFarmLoop()
    end)
end

function StopAutoFarm()
    Config.Enabled = false
    print("[AUTO FARM] ƒê√£ d·ª´ng Auto Farm")
    
    StartBtn.Visible = true
    StopBtn.Visible = false
    
    currentTarget = nil
    isFlyingToTarget = false
    isOnHead = false
    isWaitingForTarget = false
    isGomming = false
    gomTargets = {}
    
    -- D·ª´ng bay
    if flyConnection then
        flyConnection:Disconnect()
        flyConnection = nil
    end
    
    -- D·ª´ng farm
    if farmConnection then
        farmConnection:Disconnect()
        farmConnection = nil
    end
    
    -- T·∫Øt xuy√™n t∆∞·ªùng
    DisableNoClip()
    
    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    
    UpdateGUI()
end

-- ==================== KH·ªûI ƒê·ªòNG ====================
function Initialize()
    print("üéÆ Auto Farm Qu√©t Qu√°i 5000 Studs - by M·∫°c B√°ch")
    print("üöÄ T√çNH NƒÇNG N√ÇNG CAO:")
    print("  - Qu√©t qu√°i trong ph·∫°m vi 5000 studs")
    print("  - Bay t·ªëc ƒë·ªô 250 m·∫∑c ƒë·ªãnh")
    print("  - Xuy√™n t∆∞·ªùng (NoClip)")
    print("  - ƒê·ª©ng tr√™n ƒë·∫ßu qu√°i")
    print("  - T·ª± ƒë·ªông t·∫•n c√¥ng cho ƒë·∫øn khi ch·∫øt")
    print("  - Chuy·ªÉn sang m·ª•c ti√™u ti·∫øp theo")
    print("  - GOM QU√ÅI: Gom 4 qu√°i v√†o 1 ch·ªó ƒë·ªÉ ƒë√°nh")
    print("  - LOGO MB: Hi·ªáu ·ª©ng Rainbow + ·∫®n/Hi·ªán GUI")
    
    -- T·∫°o GUI
    CreateGUI()
    
    -- T·∫°o logo MB
    CreateMBLogo()
    
    -- S·ª± ki·ªán n√∫t
    StartBtn.MouseButton1Click:Connect(StartAutoFarm)
    StopBtn.MouseButton1Click:Connect(StopAutoFarm)
    NoClipToggleBtn.MouseButton1Click:Connect(ToggleNoClip)
    GomQuaiToggleBtn.MouseButton1Click:Connect(ToggleGomQuai)
    SpeedUpBtn.MouseButton1Click:Connect(function() ChangeSpeed(10) end)
    SpeedDownBtn.MouseButton1Click:Connect(function() ChangeSpeed(-10) end)
    
    -- Ph√≠m t·∫Øt
    UserInputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.F5 then
            if Config.Enabled then
                StopAutoFarm()
            else
                StartAutoFarm()
            end
        elseif input.KeyCode == Enum.KeyCode.F6 then
            -- T·∫Øt to√†n b·ªô
            StopAutoFarm()
            local gui = player.PlayerGui:FindFirstChild("AutoFarmGUI")
            if gui then
                gui:Destroy()
            end
            CleanupLogo()
            print("üîå ƒê√£ t·∫Øt Auto Farm")
        elseif input.KeyCode == Enum.KeyCode.N then
            ToggleNoClip()
        elseif input.KeyCode == Enum.KeyCode.G then
            ToggleGomQuai()
        elseif input.KeyCode == Enum.KeyCode.Equals or input.KeyCode == Enum.KeyCode.Plus then
            ChangeSpeed(10)
        elseif input.KeyCode == Enum.KeyCode.Minus then
            ChangeSpeed(-10)
        elseif input.KeyCode == Enum.KeyCode.H then
            -- Ph√≠m t·∫Øt ·∫©n/hi·ªán GUI
            if MainFrame then
                MainFrame.Visible = not MainFrame.Visible
                if MainFrame.Visible and Config.RainbowGUI then
                    StartRainbowGUI()
                elseif not MainFrame.Visible then
                    StopRainbowGUI()
                end
                print("[HOTKEY] ƒê√£ " .. (MainFrame.Visible and "hi·ªán" or "·∫©n") .. " GUI")
            end
        elseif input.KeyCode == Enum.KeyCode.R then
            -- Ph√≠m t·∫Øt b·∫≠t/t·∫Øt rainbow
            ToggleRainbowGUI()
        end
    end)
    
    -- C·∫≠p nh·∫≠t GUI m·ªói gi√¢y
    spawn(function()
        while true do
            task.wait(1)
            UpdateGUI()
        end
    end)
    
    -- X·ª≠ l√Ω khi nh√¢n v·∫≠t ch·∫øt
    humanoid.Died:Connect(function()
        print("[H·ªÜ TH·ªêNG] Nh√¢n v·∫≠t ƒë√£ ch·∫øt, d·ª´ng Auto Farm")
        StopAutoFarm()
    end)
    
    -- X·ª≠ l√Ω khi h·ªìi sinh
    player.CharacterAdded:Connect(function(newChar)
        print("[H·ªÜ TH·ªêNG] Nh√¢n v·∫≠t h·ªìi sinh")
        character = newChar
        humanoid = newChar:WaitForChild("Humanoid")
        humanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
        
        task.wait(2)
        
        if Config.Enabled then
            print("[H·ªÜ TH·ªêNG] T·ª± ƒë·ªông ti·∫øp t·ª•c Auto Farm")
            StopAutoFarm()
            task.wait(1)
            StartAutoFarm()
        end
    end)
    
    -- Ki·ªÉm tra module combat
    if RegisterAttack and RegisterHit then
        print("‚úÖ ƒê√£ t√¨m th·∫•y module Combat")
        Config.CombatEnabled = true
    else
        print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y module Combat")
        print("‚ö†Ô∏è Auto Farm s·∫Ω s·ª≠ d·ª•ng t·∫•n c√¥ng c∆° b·∫£n")
        Config.CombatEnabled = true
    end
    
    print("\n‚úÖ Script ƒë√£ s·∫µn s√†ng!")
    print("   F5: B·∫≠t/T·∫Øt Auto Farm")
    print("   F6: T·∫Øt script")
    print("   N: B·∫≠t/T·∫Øt xuy√™n t∆∞·ªùng")
    print("   G: B·∫≠t/T·∫Øt gom qu√°i")
    print("   +/-: TƒÉng/Gi·∫£m t·ªëc ƒë·ªô")
    print("   H: ·∫®n/Hi·ªán GUI")
    print("   R: B·∫≠t/T·∫Øt Rainbow GUI")
    print("   Logo MB: Click ·∫©n/hi·ªán GUI, Double Click b·∫≠t/t·∫Øt Rainbow")
    print("   Ph·∫°m vi qu√©t: " .. Config.ScanRange .. " studs")
    print("   T·ªëc ƒë·ªô m·∫∑c ƒë·ªãnh: " .. Config.CurrentSpeed)
    print("   Xuy√™n t∆∞·ªùng m·∫∑c ƒë·ªãnh: " .. (Config.NoClip and "B·∫¨T" or "T·∫ÆT"))
    print("   Gom qu√°i m·∫∑c ƒë·ªãnh: " .. (Config.GomQuai and "B·∫¨T" or "T·∫ÆT"))
    print("   Rainbow GUI m·∫∑c ƒë·ªãnh: " .. (Config.RainbowGUI and "B·∫¨T" or "T·∫ÆT"))
end

-- ==================== CH·∫†Y SCRIPT ====================
Initialize()
